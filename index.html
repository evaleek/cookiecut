<!DOCTYPE html>
<html lang="en" style="height:100%;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CookieCut</title>
    <style>
        #levels {
            display: flex;
        }

        #level-ranges {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        #level-ranges > * {
            flex: 1;
        }

        #level-glyph-lists {
            display: flex;
            flex-direction: column;
        }

        #level-glyph-lists * {
            flex: 1;
        }
    </style>
</head>
<body>
    <script type="module" src="./cookiecut.js"></script>
    <script type="module">
        import * as cc from './cookiecut.js';

        const image = document.getElementById("user-image");
        const imageUpload = document.getElementById("user-image-upload");
        const cellSize = document.getElementById("cell-size");
        const canvas = document.getElementById("canvas");
        const addLevel = document.getElementById("add-level");
        const removeLevel = document.getElementById("remove-level");
        const levels = document.getElementById("levels");
        const activeGlyphs = document.getElementById("active-glyphs");
        const output = document.getElementById("output");

        // TODO check for WebGL support and fail clearly to user

        function onImageUpload() {
            const len = imageUpload.files.length;
            if (len == 1 && imageUpload.files[0].type.startsWith("image/")) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    image.src = e.target.result;
                    image.onload = function() {
                        cc.setImage(image);
                        canvas.style.display = "inline";
                        writeOutput(cc.findCellMatches());
                        canvas.width = cc.imageSize[0];
                        canvas.height = cc.imageSize[1];
                        cc.drawMeans();
                    };
                };
                // TODO handle read failure
                reader.readAsDataURL(imageUpload.files[0]);
            } else {
                image.src = '';
                cc.setImage(null);
                canvas.style.display = "none";
                if (len > 1) {
                    console.error("unexpected file upload count " + len);
                }
            }
        }

        function setGlyphs(characters) {
            for (const character of characters) {
                if (character.length != 1 || typeof character !== 'string')
                    throw new Error("character parameter was not a length-1 string");
            }

            cc.setGlyphs(characters);

            while (activeGlyphs.firstChild) {
                activeGlyphs.removeChild(activeGlyphs.firstChild);
            }

            const glyphs = cc.writeGlyphs(characters);
            for (const glyph of glyphs) {
                let img = document.createElement('img');
                img.src = glyph;
                activeGlyphs.appendChild(img);
            }
        }

        function writeOutput(characters) {
            output.rows = characters.length;
            output.cols = characters[0].length;
            output.value = characters.map((row) => row.join('')).join('\n');
        }

        function getLevels() {
            const ranges = Array.from(
                document.getElementById("level-ranges").children)
                .filter((element) => element.nodeName == "INPUT" &&
                                     element.getAttribute("type") == "range" &&
                                     element.classList.contains("level-range"));
            const glyphLists = Array.from(
                document.getElementById("level-glyph-lists").children)
                .filter((element) => element.nodeName == "DIV" &&
                                     element.classList.contains("level-glyph-list"));
            if (ranges.length != glyphLists.length) {
                console.warn("found " + ranges.length +
                " level ranges but " + glyphLists.length +
                " glyph lists in the levels node");
            }

            return ranges.map((range, idx) => ({
                range: range,
                glyphs: {
                    node: glyphLists[idx],
                    glyphs: Array.from(glyphLists[idx].children)
                                .filter((child) => child.nodeName == "IMG")
                                .map((child) => ({
                                    node: child,
                                    character: child.className,
                                })),
                },
            }));
        }

        function onAddLevel() {
            const levelRange = document.getElementById("range-template")
                                       .content.cloneNode(true)
                                       .firstElementChild;
            const levelNodes = getLevels();
            if (levelNodes.length > 0) {
                const tailLevel = levelNodes.map((level) => level.range).at(-1);
                const floorValue = Number(tailLevel.value);
                const midValue = floorValue + ((1.0 - floorValue)*0.5);
                const size = Math.min(Math.round((1.0 - floorValue)*100), 100);

                levelRange.style.inlineSize = `${size}%`;
                levelRange.setAttribute("min", floorValue);
                levelRange.value = midValue;

                levelRange.inputListener = (e) => {
                    const newFloor = Number(e.target.value);
                    const newSize = Math.min(Math.round((1.0 - newFloor)*100), 100);
                    levelRange.style.inlineSize = `${newSize}%`;
                    levelRange.setAttribute("min", newFloor);
                    levelRange.dispatchEvent(new Event("input"));
                };
                tailLevel.addEventListener("input", levelRange.inputListener);
            } else {
                levelRange.style.inlineSize = "100%";
                levelRange.setAttribute("min", 0);
                levelRange.value = 0.5;
            }


            document.getElementById("level-ranges").appendChild(levelRange);

            const levelGlyphs = document.getElementById("glyph-list-template")
                                        .content.cloneNode(true)
                                        .firstElementChild;
            document.getElementById("level-glyph-lists").appendChild(levelGlyphs);
        }

        function onRemoveLevel() {
            const levelNodes = getLevels();
            if (levelNodes.length > 0) {
                const lastLevel = levelNodes.at(-1);
                if (lastLevel.range.inputListener) {
                    lastLevel.range.removeEventListener("input",
                        lastLevel.range.inputListener);
                }
                document.getElementById("level-ranges")
                    .removeChild(lastLevel.range);
                document.getElementById("level-glyph-lists")
                    .removeChild(lastLevel.glyphs.node);
            }
        }

        function onChangeLevels() {
            if (getLevels()?.length > 0) {
                removeLevel.disabled = false;
            } else {
                removeLevel.disabled = true;
            }
        }

        cc.init(canvas);
        cc.setCellSize(cellSize.value);
        imageUpload.addEventListener("change", onImageUpload);
        cellSize.addEventListener("change", (e) => {
            cc.setCellSize(e.target.value);
        });
        addLevel.addEventListener("click", onAddLevel);
        addLevel.addEventListener("click", onChangeLevels);
        removeLevel.addEventListener("click", onRemoveLevel);
        removeLevel.addEventListener("click", onChangeLevels);
        onChangeLevels();

        setGlyphs(['.', ':', ' ']);
        onImageUpload();

    </script>
    <img id="user-image">
    <input type="number" id="cell-size" min="4" step="1" value="8">
    <input type="file" id="user-image-upload" accept="image/*">
    <canvas id="canvas"></canvas>
    <div id="levels-control">
        <input type="button" id="remove-level" value="Remove level">
        <input type="button" id="add-level" value="Add level">
    </div>
    <div id="levels">
        <div id="level-ranges">
            <template id="range-template">
                <input type="range" class="level-range" step="any" max="1" style="inline-size:100%">
            </template>
        </div>
        <div id="level-glyph-lists">
            <template id="glyph-list-template"><div class="level-glyph-list">
                <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAB0klEQVRYR+2WSyhEURjHx/uVxMKjlDySSCzETlE2UkQpkg0LUuztZaeUV7FSlCTJimJjIUlskOy8l0qxk9+/ztRNZs41nWk296tf37lz7vzPf777nTM3KZTgSErw+qHAQFCB/1SgkIbtgjZogDLIhnd4hmNYh6v/NLZfA32IbkGKRfyb+SWYAo2t4dfAKEqrRu2BfAb38AG50AgdkGbuWSGPW1fnBr8Ghrm3HRbhPIJwHZ8fQZGZbyJf2Ez4NWDTCc9PMFgwF7PkadsXXRuoZcFrs+geuSdeBnIQroA8yPA8ygLGalbFCbS6NJCFmEo8BPWQbBFXrzS7MlCO0CFU2QQ982pANWLU8NMD2lqXoC5X6BnPmRI/kb88K5QwfjHXzgz0IrhjRLX/dRJ6F/X+whoubl0bmEdw0oj2k7ej1FRdv+vawCaCA0ZUXa3ujhRrTIy4NrCM4JgR1S7QWf9XqPzqlUzXBgYR3DCir+QWePzlQA26D9ot4XDWhOko3kClUf4k67C5g1TQXu80Y1Ur/CfkzIDW1RF7AKURyq+P9WhmQO8GCqcGJJgP2g3dUA16N3iDU1Dz6YWkGPSY4mIgyo+PfcrPSRi7uo9vBgaCCgQV+AGxpEoh5HqrQAAAAABJRU5ErkJggg==">
                <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAB0klEQVRYR+2WSyhEURjHx/uVxMKjlDySSCzETlE2UkQpkg0LUuztZaeUV7FSlCTJimJjIUlskOy8l0qxk9+/ztRNZs41nWk296tf37lz7vzPf777nTM3KZTgSErw+qHAQFCB/1SgkIbtgjZogDLIhnd4hmNYh6v/NLZfA32IbkGKRfyb+SWYAo2t4dfAKEqrRu2BfAb38AG50AgdkGbuWSGPW1fnBr8Ghrm3HRbhPIJwHZ8fQZGZbyJf2Ez4NWDTCc9PMFgwF7PkadsXXRuoZcFrs+geuSdeBnIQroA8yPA8ygLGalbFCbS6NJCFmEo8BPWQbBFXrzS7MlCO0CFU2QQ982pANWLU8NMD2lqXoC5X6BnPmRI/kb88K5QwfjHXzgz0IrhjRLX/dRJ6F/X+whoubl0bmEdw0oj2k7ej1FRdv+vawCaCA0ZUXa3ujhRrTIy4NrCM4JgR1S7QWf9XqPzqlUzXBgYR3DCir+QWePzlQA26D9ot4XDWhOko3kClUf4k67C5g1TQXu80Y1Ur/CfkzIDW1RF7AKURyq+P9WhmQO8GCqcGJJgP2g3dUA16N3iDU1Dz6YWkGPSY4mIgyo+PfcrPSRi7uo9vBgaCCgQV+AGxpEoh5HqrQAAAAABJRU5ErkJggg==">
            </div></template>
        </div>
    </div>
    <div id="active-glyphs"></div>
    <textarea id="output" readonly></textarea>
</body>
</html>
